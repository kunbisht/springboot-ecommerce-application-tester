# GitLab CI/CD Pipeline for Java Spring Boot Application
# Generated by CICDagent - Multi-Platform CI/CD Pipeline Orchestrator
# Platform: GitLab CI
# Target Branch: feature/feature-1
# Programming Language: Java
# Framework: Spring Boot
# Build Tool: Maven

# Pipeline Configuration
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Pipeline Stages
stages:
  - checkout_and_build
  - unit_test
  - code_analysis

# Services
services:
  - name: docker:24.0.5-dind
    alias: docker
    variables:
      DOCKER_TLS_CERTDIR: "/certs"

# Global Cache Configuration
cache:
  paths:
    - .m2/repository/
    - target/

# Stage 1: Checkout and Build
checkout_and_build:
  stage: checkout_and_build
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo 'Checking out code for GitLab CI'
    - echo 'Target branch feature/feature-1'
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - echo 'Installing Java and Maven dependencies'
    - java -version
    - mvn -version
  script:
    - echo 'Building Spring Boot application with Maven'
    - mvn clean compile -B $MAVEN_CLI_OPTS
    - mvn package -DskipTests=true -B $MAVEN_CLI_OPTS
  after_script:
    - echo 'Build completed for Java Spring Boot application'
    - ls -la target/ || true
  artifacts:
    paths:
      - target/
    expire_in: 7d
  cache:
    key: maven-cache-$CI_COMMIT_REF_SLUG
    paths:
      - .m2/repository/

# Stage 2: Unit Tests
unit_test:
  stage: unit_test
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - checkout_and_build
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo 'Preparing unit test environment for Java Spring Boot'
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - mkdir -p reports
  script:
    - echo 'Running unit tests with Maven Surefire plugin'
    - mvn test -B $MAVEN_CLI_OPTS
    - echo 'Generating test reports'
    - mvn surefire-report:report -B $MAVEN_CLI_OPTS
  after_script:
    - echo 'Unit tests completed'
    - echo 'Collecting test artifacts'
    - ls -la target/surefire-reports/ || true
  artifacts:
    paths:
      - target/surefire-reports/
      - target/site/surefire-report.html
      - reports/
    expire_in: 7d
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
  cache:
    key: maven-cache-$CI_COMMIT_REF_SLUG
    paths:
      - .m2/repository/

# Stage 3: Code Analysis Jobs (Feature Branch Only)
# Code Linter Job
code_linter:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo 'Installing Checkstyle for Java code linting'
    - apt-get update && apt-get install -y curl wget unzip
    - mkdir -p reports
    - wget -q https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar -O /opt/checkstyle.jar
  script:
    - echo 'Running Checkstyle code linting for Java'
    - java -jar /opt/checkstyle.jar -c checkstyle.xml src/ || echo 'Checkstyle completed with findings'
  after_script:
    - echo 'Code linting completed'
    - ls -la reports/ || true
  artifacts:
    paths:
      - reports/
    expire_in: 7d
  allow_failure: false

# Security Linter Job
security_linter:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo 'Installing OWASP Dependency Check for security analysis'
    - apt-get update && apt-get install -y wget unzip openjdk-11-jdk
    - wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
    - unzip -q dependency-check-8.4.0-release.zip
    - export PATH=$PATH:$(pwd)/dependency-check/bin
    - mkdir -p security-report
  script:
    - echo 'Running OWASP Dependency Check for Java dependencies'
    - dependency-check/bin/dependency-check.sh --scan . --format HTML --out security-report/ || echo 'Security scan completed with findings'
  after_script:
    - echo 'Security linting completed'
    - ls -la security-report/ || true
  artifacts:
    paths:
      - security-report/
    expire_in: 1 week
  allow_failure: false

# Secret Scan Job
secret_scan:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo 'Installing Gitleaks for secret detection'
    - apt-get update && apt-get install -y curl wget ca-certificates tar jq
    - export GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name' | sed 's/^v//')
    - echo "Installing Gitleaks ${GITLEAKS_VERSION}"
    - wget -qO /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
    - tar -xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks
    - chmod +x /usr/local/bin/gitleaks
    - gitleaks version
    - mkdir -p secret-scan-report
  script:
    - echo 'Running Gitleaks secret detection on the entire codebase'
    - gitleaks detect --source . --report-format json --report-path secret-scan-report/gitleaks-report.json || echo 'Secret scan completed with findings'
  after_script:
    - echo 'Secret detection completed'
    - ls -la secret-scan-report/ || true
  artifacts:
    paths:
      - secret-scan-report/
    expire_in: 1 week
  allow_failure: false

# Pipeline Completion
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always