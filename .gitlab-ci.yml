# GitLab CI/CD Pipeline for Spring Boot E-commerce Application
# Platform: GitLab CI
# Target Branch: feature/feature-1
# Generated by CI/CD Pipeline Orchestrator

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  DOCKER_TLS_CERTDIR: "/certs"

# Define pipeline stages
stages:
  - checkout_and_build
  - unit_test
  - code_analysis

# Cache configuration for Maven dependencies
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .m2/repository/
    - target/

# Services for Docker-in-Docker
services:
  - name: docker:24.0.5-dind
    alias: docker

# Default image and tags
default:
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner

# Stage 1: Checkout and Build
checkout_and_build:
  stage: checkout_and_build
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo "Checking out code for GitLab CI"
    - echo "Target branch feature/feature-1"
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - apt-get install -y openjdk-17-jdk maven
    - java -version
    - mvn --version
  script:
    - echo "Building Spring Boot application with Maven"
    - mvn $MAVEN_CLI_OPTS clean compile -DskipTests=true
    - mvn $MAVEN_CLI_OPTS package -DskipTests=true
  after_script:
    - echo "Build completed for Spring Boot application"
    - ls -la target/ || true
  artifacts:
    paths:
      - target/
    expire_in: 7 days
  cache:
    key: "$CI_COMMIT_REF_SLUG-build"
    paths:
      - .m2/repository/

# Stage 2: Unit Tests
unit_test:
  stage: unit_test
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - checkout_and_build
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo "Auto-detecting language and installing prerequisites"
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - apt-get install -y openjdk-17-jdk maven
    - mkdir -p reports
  script:
    - echo "Running Maven Surefire tests for Spring Boot application"
    - mvn $MAVEN_CLI_OPTS test
    - mvn $MAVEN_CLI_OPTS surefire-report:report
  after_script:
    - echo "Unit tests completed"
    - echo "Collecting artifacts"
    - ls -la target/surefire-reports/ || true
    - ls -la reports/ || true
  artifacts:
    paths:
      - target/surefire-reports/
      - target/site/surefire-report.html
      - reports/
    expire_in: 7 days
    reports:
      junit:
        - target/surefire-reports/*.xml
  coverage: '/Total.*?([0-9]{1,3})%/'

# Stage 3: Code Analysis (runs only on feature/* branches)
code_analysis:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo "Installing code analysis tools for Java Spring Boot project"
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq python3-pip
    - mkdir -p reports/code-analysis
    - mkdir -p reports/security
    - mkdir -p reports/secrets
  script:
    # Code Linting with Checkstyle
    - echo "Running Checkstyle code linting"
    - mvn $MAVEN_CLI_OPTS checkstyle:checkstyle || true
    - cp target/checkstyle-result.xml reports/code-analysis/ || true
    
    # Security Analysis with SpotBugs
    - echo "Running SpotBugs security analysis"
    - mvn $MAVEN_CLI_OPTS com.github.spotbugs:spotbugs-maven-plugin:spotbugs || true
    - cp target/spotbugsXml.xml reports/security/ || true
    
    # Dependency Check
    - echo "Running OWASP Dependency Check"
    - mvn $MAVEN_CLI_OPTS org.owasp:dependency-check-maven:check || true
    - cp target/dependency-check-report.xml reports/security/ || true
    
    # Secret Scanning with Gitleaks
    - echo "Installing and running Gitleaks for secret detection"
    - wget -qO /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz"
    - tar -xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks
    - chmod +x /usr/local/bin/gitleaks
    - gitleaks detect --source . --report-format json --report-path reports/secrets/gitleaks-report.json || echo "Secret scan completed with findings"
  after_script:
    - echo "Code analysis completed"
    - echo "Reports saved in artifacts"
    - ls -la reports/ || true
  artifacts:
    paths:
      - reports/
      - target/checkstyle-result.xml
      - target/spotbugsXml.xml
      - target/dependency-check-report.xml
    expire_in: 7 days
    reports:
      junit:
        - target/surefire-reports/*.xml
  allow_failure: false

# Global pipeline configuration
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
    - when: never

# Pipeline success notification
pipeline_success:
  stage: .post
  image: alpine:latest
  tags:
    - mainrunner
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: on_success
  script:
    - echo "Pipeline completed successfully for Spring Boot E-commerce Application"
    - echo "Branch feature/feature-1"
    - echo "All stages passed - checkout_and_build, unit_test, code_analysis"