# CI/CD Pipeline for Java + Spring Boot on gitlab
# Generated for springboot-ecommerce-application-tester
# Target branch: feature/feature-1

image: maven:3.9.6-eclipse-temurin-17

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  PROGRAMMING_LANGUAGE: "java"
  FRAMEWORK: "spring-boot"
  BUILD_TOOL: "maven"
  RUNNER_IMAGE: "maven:3.9.6-eclipse-temurin-17"

cache:
  paths:
    - .m2/repository/
    - target/

stages:
  - checkout_and_build
  - unit_test
  - code_analysis

# Checkout and Build Stage
checkout_and_build:
  stage: checkout_and_build
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo 'Checking out code for gitlab'
    - echo 'Target branch feature/feature-1'
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - apt-get install -y openjdk-17-jdk maven
  script:
    - echo 'Installing build tool for java'
    - mvn clean install -B
  after_script:
    - echo 'Build completed for java'
    - ls -la target || true
  artifacts:
    paths:
      - target/
    expire_in: 7d

# Unit Test Stage  
unit_test:
  stage: unit_test
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - checkout_and_build
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo 'Auto-detecting language and installing prerequisites...'
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - echo 'Detected language java'
    - apt-get install -y openjdk-17-jdk maven
    - mkdir -p reports
  script:
    - echo 'Selecting test runner and command based on code context...'
    - echo 'Resolved TEST_CMD mvn -B -DskipTests=false test'
    - mvn -B -DskipTests=false test
  after_script:
    - echo 'Unit tests completed'
    - echo 'Collecting artifacts...'
    - ls -la reports || true
  artifacts:
    paths:
      - reports/
      - target/surefire-reports/
    expire_in: 7d
    reports:
      junit:
        - target/surefire-reports/*.xml

# Code Analysis Stage (Feature branches only)
code_analysis:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo 'Installing code analysis tools for feature branch'
    - apt-get update && apt-get install -y curl wget ca-certificates tar jq python3-pip
    - mkdir -p reports security-scan-report secret-scan-report
  script:
    # Code Linting with Checkstyle
    - echo 'Running Checkstyle for Java code linting'
    - wget -O checkstyle.jar https://github.com/checkstyle/checkstyle/releases/download/checkstyle-10.12.4/checkstyle-10.12.4-all.jar
    - java -jar checkstyle.jar -c checkstyle.xml src/ || echo 'Checkstyle completed with findings'
    
    # Security Scanning with Dependency Check
    - echo 'Running OWASP Dependency Check for security analysis'
    - wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
    - unzip dependency-check-8.4.0-release.zip
    - ./dependency-check/bin/dependency-check.sh --scan . --format HTML --out security-scan-report/ || echo 'Security scan completed with findings'
    
    # Secret Scanning with Gitleaks
    - echo 'Installing and running Gitleaks for secret detection'
    - export GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name' | sed 's/^v//')
    - wget -qO gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
    - tar -xzf gitleaks.tar.gz
    - chmod +x gitleaks
    - ./gitleaks detect --source . --report-format json --report-path secret-scan-report/gitleaks-report.json || echo 'Secret scan completed with findings'
  after_script:
    - echo 'Code analysis completed for feature branch'
    - echo 'Reports saved in artifacts'
  artifacts:
    paths:
      - reports/
      - security-scan-report/
      - secret-scan-report/
    expire_in: 1 week
  allow_failure: false

# Services for Docker-in-Docker if needed
services:
  - docker:24.0.5-dind

# Global retry configuration
.retry_config: &retry_config
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
      - unknown_failure