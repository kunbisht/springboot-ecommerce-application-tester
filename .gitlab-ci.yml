# CI/CD Pipeline for Java + Spring Boot on GitLab
# Generated by CHECKOUT_BUILD_STAGE, UNIT_TEST_STAGE, and CODE_ANALYSIS_STAGE
# Code analysis jobs run only on feature/* branches

# Global variables
variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  PROGRAMMING_LANGUAGE: "java"
  FRAMEWORK: "spring-boot"
  BUILD_TOOL: "maven"
  RUNNER_IMAGE: "maven:3.9.6-eclipse-temurin-17"

# Pipeline stages
stages:
  - checkout_and_build
  - unit_test
  - code_analysis

# Cache configuration for Maven dependencies
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .m2/repository/

# Services
services:
  - name: docker:24.0.5-dind
    alias: docker
    variables:
      DOCKER_TLS_CERTDIR: "/certs"

# Checkout and Build Stage
checkout_and_build:
  stage: checkout_and_build
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo 'Checking out code for GitLab'
    - echo 'Target branch feature/feature-1'
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - apt-get install -y openjdk-17-jdk maven
  script:
    - echo 'Installing build tool for Java'
    - mvn clean install -B
  after_script:
    - echo 'Build completed for Java'
    - ls -la target || true
  artifacts:
    paths:
      - target/
    expire_in: 7d

# Unit Test Stage
unit_test:
  stage: unit_test
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - checkout_and_build
  rules:
    - if: '$CI_COMMIT_BRANCH == "feature/feature-1"'
      when: always
  before_script:
    - echo 'Auto-detecting language and installing prerequisites...'
    - apt-get update && apt-get install -y curl wget unzip tar gzip git jq
    - LANG_HINT="java"
    - echo "Detected language $LANG_HINT"
    - apt-get install -y openjdk-17-jdk maven
    - mkdir -p reports
  script:
    - echo 'Selecting test runner and command based on code context...'
    - TEST_CMD="mvn -B -DskipTests=false test"
    - echo "Resolved TEST_CMD $TEST_CMD"
    - bash -lc "$TEST_CMD"
  after_script:
    - echo 'Unit tests completed'
    - echo 'Collecting artifacts...'
    - ls -la reports || true
  artifacts:
    paths:
      - reports/
      - target/surefire-reports/
    expire_in: 7d
    reports:
      junit:
        - target/surefire-reports/*.xml

# Code Analysis Stage - Code Linter Job
code_linter:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - export LANG_TARGET="java"
    - mkdir -p reports
    - cat > .ci-lint.sh <<'EOF'
set -e
LANG="$LANG_TARGET"
CHECKSTYLE_VERSION="10.12.4"
log(){ echo "[lint] $1"; }
setup_linter(){
  case "$LANG" in
    java)
      command -v java >/dev/null || { log "Java runtime not found"; exit 1; }
      curl -sSL -o /opt/checkstyle.jar "https://github.com/checkstyle/checkstyle/releases/download/checkstyle-${CHECKSTYLE_VERSION}/checkstyle-${CHECKSTYLE_VERSION}-all.jar"
      ;;
  esac
}
verify_linter(){
  case "$LANG" in
    java) java -jar /opt/checkstyle.jar --version || log "Checkstyle verification failed";;
  esac
}
run_lint(){
  mkdir -p reports
  case "$LANG" in
    java)
      CMD="java -jar /opt/checkstyle.jar -c checkstyle.xml src/"
      ;;
  esac
  bash -lc "$CMD" || true
}
setup_linter
verify_linter
run_lint
EOF
    - bash ./.ci-lint.sh
  script:
    - echo 'Linting executed via .ci-lint.sh'
  after_script:
    - echo 'Collecting and archiving reports'
    - ls -la reports || true
  artifacts:
    paths:
      - reports/
    expire_in: 7d

# Code Analysis Stage - Security Linter Job
security_linter:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo 'Installing security linter for Java'
    - mkdir -p security-report
    - apt-get update && apt-get install -y openjdk-11-jdk wget unzip
    - wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
    - unzip dependency-check-8.4.0-release.zip && export PATH=$PATH:$(pwd)/dependency-check/bin
  script:
    - echo 'Running security linting for Java'
    - dependency-check --scan . --format HTML
  after_script:
    - echo 'Security linting completed. Reports saved in artifacts.'
  artifacts:
    paths:
      - security-report/
    expire_in: 1 week

# Code Analysis Stage - Secret Scan Job
secret_scan:
  stage: code_analysis
  image: maven:3.9.6-eclipse-temurin-17
  tags:
    - mainrunner
  needs:
    - unit_test
  rules:
    - if: '$CI_COMMIT_BRANCH =~ /^feature\//'
      when: always
  before_script:
    - echo 'Installing dependencies for Gitleaks secret detection'
    - apt-get update && apt-get install -y curl wget ca-certificates tar jq
    - echo 'Resolving latest Gitleaks version'
    - export GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name' | sed 's/^v//')
    - echo "Installing Gitleaks ${GITLEAKS_VERSION}"
    - wget -qO /tmp/gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
    - tar -xzf /tmp/gitleaks.tar.gz -C /usr/local/bin gitleaks
    - chmod +x /usr/local/bin/gitleaks
    - echo 'Verifying Gitleaks installation'
    - gitleaks version
    - mkdir -p secret-scan-report
  script:
    - echo 'Running Gitleaks secret detection on the entire codebase'
    - gitleaks detect --source . --report-format json --report-path secret-scan-report/gitleaks-report.json || echo 'Secret scan completed with findings'
  after_script:
    - echo 'Secret detection completed. Reports saved in artifacts.'
  artifacts:
    paths:
      - secret-scan-report/
    expire_in: 1 week